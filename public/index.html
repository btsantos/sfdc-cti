<!DOCTYPE html>
<html>
<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
	<link href="css/normalize.css" rel="stylesheet" type="text/css" />
	<link href="css/bootstrap.css" rel="stylesheet" type="text/css" />
	<link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
	<link href="css/main.css" rel="stylesheet" type="text/css" />

	<!--script src="/socket.io/socket.io.js"></script-->
	<link rel="stylesheet" href="jquery-ui.css" />
	<script src="jquery.js"></script>
	<script src="jquery-ui.js"></script>
	<script src="jquery.base64.js"></script>
	<script src="js/plugins.js"></script> 
	<script src="js/main-mini.js"></script>
	<script src="https://c.na1.visual.force.com/support/api/30.0/interaction.js" type="text/javascript"></script>
	<script>
		function startHeartbeat(){
			setTimeout(function(){
				$.ajax({
					url: '/heartbeat/?username=' + localStorage.getItem('username'),
					success:function(result){
						startHeartbeat();
			}
		});
			}, 15000);
		};

		function connect(username){
			var mainXhr = new XMLHttpRequest();
			console.log('/connect/?username=' + username);
			var url = '/connect/?username=' + username;
			mainXhr.open('GET', url, true);
			mainXhr.onreadystatechange = function() {
				console.log('mainXhr.onreadystatechange called. State is ' + mainXhr.readyState);
				var eventtype = $(mainXhr.responseText).find('eventtype').text();
				switch(eventtype){
					case 'CallReceivedEvent':
						console.log("CallReceivedEvent received");
						var callerid = $(mainXhr.responseText).find('callerid').text();
						localStorage.setItem('callNumber', callerid);
						localStorage.setItem('calledtype', "inbound");
						localStorage.setItem("softphonestate", 'incomingcall');
						localStorage.setItem('callLogSubject', 'Call On');
						$('.number').html('<p><sup>Call From:</sup><br>' + callerid + '</p>');
						break;
					case 'CallOriginatedEvent':
						console.log("CallOriginatedEvent received");
						var callingid = $(mainXhr.responseText).find('callingid').text();
						localStorage.setItem('callNumber', callingid);
						localStorage.setItem('calledtype', "outbound");
						localStorage.setItem("softphonestate", 'outgoingcall');
						localStorage.setItem('callLogSubject', 'Call On');
						$('.number').html('<p><sup>Call To:</sup><br>' + callingid + '</p>');
						break;
					case 'CallAnsweredEvent':
						console.log("CallAnsweredEvent received");
						var callstarttime = new Date().getTime();
						localStorage.setItem('callStartTime', callstarttime);
						$('.number').text('Talking');
						localStorage.setItem("softphonestate", 'busy');
						//change background color of "call" icon to #ff0000(red)
						$('.pad-action').css('background-color', '#ff0000');
						var callerid = $(mainXhr.responseText).find('callerid').text();
						sforce.interaction.searchAndScreenPop(callerid,'','inbound');
						break;
					case 'CallReleasedEvent':
						console.log("CallReleasedEvent received");
						var callendtime = new Date().getTime();
						localStorage.setItem('callEndTime', callendtime);
						localStorage.setItem("softphonestate", 'free');
						localStorage.setItem('callDisposition', 'successfull');
						$('.number').html("");
						//change background color of "call" icon to #0c3(green)
						$('.pad-action').css('background-color', '#093');
						sforce.interaction.getPageInfo(saveCallLog); //save call log in SFDC
						break;
					default:
				}
			};
			mainXhr.onloadend = function() {
				console.log('mainXhr.onloadend. Will reopen the channel');
				connect(username);
			};

			mainXhr.send();
		};

		// Callback of API method: setSoftphoneHeight
       var setSoftphoneHeightCallback = function (response) {
       	console.log("setSoftphoneHeightCallback called");
       		// Returns true if SoftPhone height was set successfully, false otherwise.
            if (response.result) {
            	console.log('Setting SoftPhone height was successful.');
            } else {
                console.log('Setting softphone height failed.');
            }
        };

		// Invokes setSoftphoneHeight API method.
        function setSoftphoneHeight(height) {
        	sforce.interaction.cti.setSoftphoneHeight(height, setSoftphoneHeightCallback);
        };

        click2diallistener = function (response) {
           if (response.result) {
              console.log('User clicked on a phone number.' + response.result );
              sforce.interaction.setVisible(true);
              if(localStorage.getItem('softphonestate') === 'free'){
              	var result = JSON.parse(response.result);
              	makecall(result.number);	
              }
           }
        };

        sforce.interaction.cti.enableClickToDial(); //enable click2dial in SFDC
        sforce.interaction.cti.onClickToDial(click2diallistener); //click2dial callback
        setSoftphoneHeight(500);
	</script>
</head>
<body>
	<!-- jQuery dial-pad -->
	<div id="main-wrapper">
		<section role="main">
		<div class="dialPad compact">
			<div class="number"></div>
				<div class="dials">
					<ol>
						<li class="digits">
							<p><strong>1</strong></p>
						</li>
						<li class="digits">
							<p><strong>2</strong><sup>abc</sup></p>
						</li>
						<li class="digits">
							<p><strong>3</strong><sup>def</sup></p>
						</li>
						<li class="digits">
			  				<p><strong>4</strong><sup>ghi</sup></p>
						</li>
						<li class="digits">
							<p><strong>5</strong><sup>jkl</sup></p>
						</li>
						<li class="digits">
							<p><strong>6</strong><sup>mno</sup></p>
						</li>
						<li class="digits">
							<p><strong>7</strong><sup>pqrs</sup></p>
						</li>
						<li class="digits">
							<p><strong>8</strong><sup>tuv</sup></p>
						</li>
						<li class="digits">
							<p><strong>9</strong><sup>wxyz</sup></p>
						</li>
						<li class="digits">
							<p><strong>*</strong></p>
						</li>
						<li class="digits">
							<p><strong>0</strong><sup>+</sup></p>
						</li>
						<li class="digits">
							<p><strong>#</strong></p>
						</li>
						<li class="digits">
							<p><strong><i class="icon-refresh icon-large"></i></strong><sup>Clear</sup></p>
						</li>
						<li class="digits">
							<p><strong><i class="icon-remove-sign icon-large"></i></strong><sup>Delete</sup></p>
						</li>
						<li class="digits pad-action">
							<p id="callaction"><strong><i class="icon-phone icon-large"></i></strong><sup>Call</sup></p>
						</li>
					</ol>
				</div>
			</div>
		</section>
	</div>
	<!-- end of sample jQuery dial-pad -->

	<!-- the BW credentials modal -->
	<div id="bw_credentials">
		<a id="credentials">PBXL</a>
		<a id="signout">Sign Out</a>
		<form id="credentials-modal-form">
			<fieldset>
				<label id="label_username">User Name:</label><br>
				<input class="text ui-widget-content ui-corner-all" class="modal-field" id="username" type="text" name="username" size="30" value="BWS_Test.zentestuser1@pbxl.net"><br>
				<label id="label_password">Password:</label><br>
				<input class="text ui-widget-content ui-corner-all" class="modal-field" id="password" type="text" name="password" value="Borras123"><br>
			</fieldset>
		</form>
	</div>
</body>

<script type="text/javascript">
	
	$('document').ready(function(){
		if(localStorage.getItem("loggedin") != "true" || !localStorage.getItem("loggedin")){
			console.log("document ready. Will open Sing In dialog");
			$( "#credentials-modal-form" ).dialog( "open" );
		}else {
			console.log("document ready and already logged in. Will connect with username " +
				localStorage.getItem(('username')));
			issignedinserver(localStorage.getItem('username'), function(result){
				if(result == true){
					connect(localStorage.getItem("username"));
					startHeartbeat();
				}else{
					localStorage.removeItem('softphonestate');
					localStorage.removeItem('loggedin');
					localStorage.removeItem('username');
					localStorage.setItem('softphonestate', 'free');
					$( "#credentials-modal-form" ).dialog( "open" );
				}
			});
		}
		//this is to cope with the fact that sfdc reloads the page during screen pop-up
		if(localStorage.getItem("softphonestate") == 'busy'){
			$('.pad-action').css('background-color', '#ff0000');
		}else {
			$('.pad-action').css('background-color', '#093');
		}
	});

	//Sign In modal form
	$('#credentials').click(function(){
		$( "#credentials-modal-form" ).dialog( "open" );
	});

	$( "#credentials-modal-form" ).dialog({
		autoOpen: false,
        modal: true,
        width: 250,
        resizable: false,
        title: "BW Credentials",
        buttons: [
        	{
        		text: "Sign In",
        		click: function(){
        			bwlogin($('#username').val(), $('#password').val());
        		},
        		style: "font-size:10px;position:relative;left:-90px",
        	},
        	{
        		text: "Cancel",
        		click: function(){
        			$( "#credentials-modal-form" ).dialog( "close" );
        		},
        		style: "font-size:10px;position:relative;left:0px",        	}
        ]
	}); 
	//End of Sign In modal form

	//Sign out process will only delete all localStorage variables
	$('#signout').click(function(){
		bwlogout(localStorage.getItem('username'));
	});

	issignedinserver = function(username, callback){  
		$.ajax({url: "/issignedin/?username=" + username, 
			success:function(result){
				callback(true);
			},
			error: function(xhr, status, result){
				callback(false);
			}
		});
	};

	bwlogin = function(username, password){
		$.ajax({url: "/log_in/?username=" + username + "&password=" + password, 
			success:function(result){
				console.log("result: " + result);
				$( "#credentials-modal-form" ).dialog( "close" );
				localStorage.setItem("loggedin", true);
				localStorage.setItem('username', username);
				$('.pad-action').css('background-color', '#093');
				localStorage.setItem('softphonestate', 'free');
				connect(username);
				startHeartbeat();
			},
			error: function(xhr, status, result){
				console.log("Status: " + status + "; result: " + result);
				if(xhr.status == 404){
					alert(xhr.status + " - " + result + ": Please verify your credentials");
				}
			}
		});
	};

	bwlogout = function(username){
		$.ajax({url: "/log_out/?username=" + username, 
			success:function(result){
				console.log("result: " + result);
				localStorage.removeItem('softphonestate');
				localStorage.removeItem('loggedin');
				localStorage.removeItem('username');
				$( "#credentials-modal-form" ).dialog( "open" );				
			},
			error: function(xhr, status, result){
				console.log("Status: " + status + "; result: " + result);
			}
		});
	};

	acceptcall = function(){
		var username = localStorage.getItem("username");
		$.ajax({url: "/accept_call/?username=" + username, 
			success:function(result){
				console.log("result: " + result);
			},
			error:function(xhr, status, result){
				console.log("Status: " + status + "; result: " + result);
			}
		});
	};

	disconnectcall = function(){
		var username = localStorage.getItem("username");
		$.ajax({url: "/disconnect_call/?username=" + username, 
			success:function(result){
				console.log("result: " + result);
			},
			error:function(xhr, status, result){
				console.log("Status: " + status + "; result: " + result);
			}
		});
	};

	makecall = function(destination){
		var username = localStorage.getItem("username");
		$.ajax({url: "/make_call/?username=" + username + "&destination=" + destination, 
			success:function(result){
				$('.number').html("Calling " + destination);
              	localStorage.setItem('callNumber', destination);
				localStorage.setItem('calledtype', "outbound");
				localStorage.setItem('callLogSubject', 'Call On');
			},
			error:function(xhr, status, result){
				console.log("Status: " + status + "; result: " + result);
			}
		});
	};

	saveCallLog = function (response) {
		console.log("saveLog called with response: " + response.result);
        var timeStamp = new Date().toString();
        timeStamp = timeStamp.substring(0, timeStamp.lastIndexOf(':') + 3);             
        var currentDate = new Date();           
        var currentDay = currentDate.getDate();
        var currentMonth = currentDate.getMonth()+1;
        var currentYear = currentDate.getFullYear();
            
        var dueDate = currentYear+ '-' + currentMonth + '-' + currentDay;
        var saveParams = 'Subject=' + localStorage.getItem('callLogSubject') + timeStamp;
        saveParams += '&Status=completed';                 
        saveParams += '&CallType=' + localStorage.getItem('calledtype');
        saveParams += '&Activitydate=' + dueDate;
        saveParams += '&CallObject=' + currentDate.getTime();
        saveParams += '&Phone=' + localStorage.getItem('callNumber');   
        saveParams += '&Description=Test call';//TODO: have to opena dialog for the agent to 
        //fill in the text + callLogText.value;   
        /*var callDisposition = getSelectedCallDisposition();
        if(callDisposition) {
            saveParams += '&CallDisposition=' + callDisposition.value;       
        } */
        saveParams += '&CallDisposition=' + localStorage.getItem('callDisposition');
        saveParams += '&CallDurationInSeconds=' + Math.floor((currentDate.getTime() - localStorage.getItem('callStartTime')/ 1000));
            
        var result = JSON.parse(response.result);
        if(result.objectId.substr(0,3) == '003') {
            saveParams += '&Who=' + result.objectId;                    
        } else {
            saveParams += '&What=' + result.objectId;            
        }
        console.log("Parameters to save in the call log: " + saveParams);
        sforce.interaction.saveLog('Task', saveParams, function(response){
        	if(response.result){
        		console.log("success in sforce.interaction.saveLog: " + response.result);
        	}else{
        		console.log("error: " + response.error);
        	}
        });         
    };

	$('#callaction').click(function(){
		var state = localStorage.getItem("softphonestate");
		switch(state){
			case 'free':
				console.log("free state and is calling to " + $('.number').text());
				makecall($('.number').text());
				break;
			case 'busy':
				disconnectcall();
				break;
			case 'incomingcall':
				acceptcall();
				break;
			default:
		} 
	});

	$('#declinecall').click(function(){
		event.preventDefault();
		var username = $('#username').val();
		$.ajax({url: "/decline_call/?username=" + username, 
			success:function(result){
				console.log("result: " + result);
			},
			error:function(xhr, status, result){
				console.log("Status: " + status + "; result: " + result);
			}
		});
	});

	function getAuthorizationHeader() {
		var header = "Basic " + $.base64.encode($('#username').val() + ":" + $('#password').val());
		return header;
	};
</script>
</html>